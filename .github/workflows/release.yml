name: Release Automation

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

env:
  FORCE_COLOR: 1

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release-created: ${{ steps.release.outputs.release_created }}
      tag-name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major-version: ${{ steps.release.outputs.major }}
    steps:
      - name: Create Release PR or Release
        id: release
        uses: googleapis/release-please-action@cc61a07e2da466bebbc19b3a7dd01d6aecb20d1e # v4.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: node

  validate-tag:
    name: Validate Release Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      major-version: ${{ steps.version.outputs.major-version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    steps:
      - name: Validate semver tag
        id: version
        run: |
          tag="${{ github.ref_name }}"
          if [[ ! "$tag" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "::error::Invalid semver tag format: $tag"
            exit 1
          fi

          version="${tag#v}"
          major_version="v${BASH_REMATCH[1]}"
          is_prerelease="false"

          if [[ -n "${BASH_REMATCH[4]}" ]]; then
            is_prerelease="true"
          fi

          {
            echo "version=$version";
            echo "major-version=$major_version";
            echo "is-prerelease=$is_prerelease";
          } >> "$GITHUB_OUTPUT"

          echo "Tag: $tag"
          echo "Version: $version"
          echo "Major version: $major_version"
          echo "Is prerelease: $is_prerelease"

  build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: validate-tag
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
        with:
          install: true
          cache: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run full test suite
        run: |
          pnpm run check
          pnpm run lint --max-warnings=0
          pnpm run test:coverage

      - name: Build and package
        run: |
          pnpm run build
          pnpm run package

      - name: Verify dist is clean
        run: |
          if [ "$(git diff --ignore-space-at-eol --text dist/ | wc -l)" -gt "0" ]; then
            echo "::error::Build produced uncommitted changes in dist/"
            git diff --ignore-space-at-eol --text dist/
            exit 1
          fi

      - name: Upload release artifacts
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: release-artifacts-${{ github.sha }}
          path: |
            dist/
            lib/
            *.md
            LICENSE
            package.json
            action.yml
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-tag, build]
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: release-artifacts-${{ github.sha }}

      - name: Generate enhanced changelog and release notes
        id: release-notes
        run: |
          # Install conventional-changelog-cli for better changelog generation
          npm install -g conventional-changelog-cli@4.1.0

          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -2 | tail -1 || echo "")
          CURRENT_TAG="${{ github.ref_name }}"
          VERSION="${CURRENT_TAG#v}"

          echo "Generating changelog from $PREVIOUS_TAG to $CURRENT_TAG"

          # Generate conventional changelog
          if [[ -n "$PREVIOUS_TAG" ]]; then
            conventional-changelog -p conventionalcommits -r 2 > temp_changelog.md
          else
            echo "# Changelog\n\n## [$VERSION] - $(date -u +%Y-%m-%d)\n\n### Added\n- Initial release of conditional-paths-action" > temp_changelog.md
          fi

          # Create comprehensive release notes
          cat > release_notes.md << EOF_RELEASE
          ## ðŸš€ What's New in $CURRENT_TAG

          EOF_RELEASE

          # Extract changes from conventional changelog
          if [[ -n "$PREVIOUS_TAG" ]]; then
            # Parse git log for conventional commits and categorize
            echo "### âœ¨ Features" >> release_notes.md
            git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | grep -E "^feat(\(.+\))?:" | sed 's/^feat\(([^)]*)\)\?:\s*/* /' >> release_notes.md || echo "No new features" >> release_notes.md
            echo "" >> release_notes.md

            echo "### ðŸ› Bug Fixes" >> release_notes.md
            git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | grep -E "^fix(\(.+\))?:" | sed 's/^fix\(([^)]*)\)\?:\s*/* /' >> release_notes.md || echo "No bug fixes" >> release_notes.md
            echo "" >> release_notes.md

            echo "### ðŸ“š Documentation" >> release_notes.md
            git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | grep -E "^docs(\(.+\))?:" | sed 's/^docs\(([^)]*)\)\?:\s*/* /' >> release_notes.md || echo "No documentation changes" >> release_notes.md
            echo "" >> release_notes.md

            echo "### âš¡ Performance" >> release_notes.md
            git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | grep -E "^perf(\(.+\))?:" | sed 's/^perf\(([^)]*)\)\?:\s*/* /' >> release_notes.md || echo "No performance improvements" >> release_notes.md
            echo "" >> release_notes.md

            echo "### ðŸ”§ Maintenance" >> release_notes.md
            git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%s" --no-merges | grep -E "^(chore|ci|build|refactor)(\(.+\))?:" | sed 's/^[^:]*:\s*/* /' >> release_notes.md || echo "No maintenance changes" >> release_notes.md
            echo "" >> release_notes.md

            # Add commit count and contributors
            COMMIT_COUNT=$(git rev-list --count "$PREVIOUS_TAG..$CURRENT_TAG")
            CONTRIBUTORS=$(git log "$PREVIOUS_TAG..$CURRENT_TAG" --format='%an' --no-merges | sort -u | wc -l | tr -d ' ')

            echo "### ðŸ“Š Release Statistics" >> release_notes.md
            echo "- **$COMMIT_COUNT** commits since $PREVIOUS_TAG" >> release_notes.md
            echo "- **$CONTRIBUTORS** contributor(s) to this release" >> release_notes.md
            echo "" >> release_notes.md
          else
            echo "### ðŸŽ‰ Initial Release" >> release_notes.md
            echo "- Complete TypeScript GitHub Action for conditional path filtering" >> release_notes.md
            echo "- Node.js 22 runtime with modern ESM support" >> release_notes.md
            echo "- Comprehensive test coverage (80%+)" >> release_notes.md
            echo "- SBOM generation and security compliance" >> release_notes.md
            echo "- DevSecOps CI/CD pipeline" >> release_notes.md
            echo "" >> release_notes.md
          fi

          # Add security and compliance info
          echo "### ðŸ”’ Security & Compliance" >> release_notes.md
          echo "- âœ… SBOM (Software Bill of Materials) included" >> release_notes.md
          echo "- âœ… All dependencies scanned for vulnerabilities" >> release_notes.md
          echo "- âœ… License compliance verified" >> release_notes.md
          echo "- âœ… Secret scanning completed" >> release_notes.md
          echo "- ðŸ“„ [View SBOM](https://santosr2.github.io/conditional-paths-action/sbom/)" >> release_notes.md
          echo "" >> release_notes.md

          # Usage section
          echo "## ðŸ“– Usage" >> release_notes.md
          echo "" >> release_notes.md
          echo '```yaml' >> release_notes.md
          echo "- uses: santosr2/conditional-paths-action@$CURRENT_TAG" >> release_notes.md
          echo "  with:" >> release_notes.md
          echo "    filters: |" >> release_notes.md
          echo "      frontend:" >> release_notes.md
          echo "        - 'src/frontend/**'" >> release_notes.md
          echo "      backend:" >> release_notes.md
          echo "        - 'src/backend/**'" >> release_notes.md
          echo "      docs:" >> release_notes.md
          echo "        - '*.md'" >> release_notes.md
          echo "        - 'docs/**'" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md

          # Links section
          echo "## ðŸ”— Links" >> release_notes.md
          echo "- ðŸ“– [Documentation](https://santosr2.github.io/conditional-paths-action/)" >> release_notes.md
          echo "- ðŸ›¡ï¸ [Security Report](https://santosr2.github.io/conditional-paths-action/security/)" >> release_notes.md
          echo "- âš¡ [Performance Report](https://santosr2.github.io/conditional-paths-action/performance/)" >> release_notes.md
          if [[ -n "$PREVIOUS_TAG" ]]; then
            echo "- ðŸ“‹ [Full Changelog](https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...$CURRENT_TAG)" >> release_notes.md
          fi
          echo "" >> release_notes.md

          # Set output for release creation
          {
            echo 'notes<<EOF'
            cat release_notes.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.release-notes.outputs.notes }}
          draft: false
          prerelease: ${{ needs.validate-tag.outputs.is-prerelease == 'true' }}
          generate_release_notes: false
          append_body: false
          make_latest: true

  update-major-tag:
    name: Update Major Version Tag
    runs-on: ubuntu-latest
    needs: [validate-tag, create-release]
    if: needs.validate-tag.outputs.is-prerelease == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Update major version tag
        run: |
          major_tag="${{ needs.validate-tag.outputs.major-version }}"
          current_tag="${{ github.ref_name }}"

          echo "Updating $major_tag to point to $current_tag"

          # Delete the major tag if it exists
          git push origin --delete "$major_tag" || true

          # Create new major tag pointing to current release
          git tag -fa "$major_tag" -m "Update $major_tag to $current_tag"
          git push origin "$major_tag"

  integration-test:
    name: Test Released Action
    runs-on: ubuntu-latest
    needs: [validate-tag, create-release]
    steps:
      - name: Checkout test repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          repository: actions/checkout
          path: test-repo

      - name: Test released action
        uses: santosr2/conditional-paths-action@${{ github.ref_name }}
        id: changes
        with:
          working-directory: test-repo
          filters: |
            workflow:
              - '.github/**'
            src:
              - 'src/**'
            docs:
              - '*.md'

      - name: Verify action works
        run: |
          echo "Testing completed successfully!"
          echo "Workflow files changed: ${{ steps.changes.outputs.workflow }}"
          echo "Source files changed: ${{ steps.changes.outputs.src }}"
          echo "Docs changed: ${{ steps.changes.outputs.docs }}"
